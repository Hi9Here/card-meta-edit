<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../browser-location/browser-location.html">
<link rel="import" href="../switchable-block/switchable-block.html">
<link rel="import" href="../location-picker/location-picker.html">
<link rel="import" href="../paper-input/paper-textarea.html">
<link rel="import" href="../image-base64/image-base64.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../input-image/input-image.html">
<link rel="import" href="../geohash-js/geohash-js.html">
<link rel="import" href="../polymer/polymer.html">
<!--
  `card-meta-edit` Edit the metadata of a card, image title descriptio
  @demo
-->
<dom-module id="card-meta-edit">
  <template>
    <style>
      :host {
        display:block;
        @apply(--layout-horizontal);
        @apply(--layout-center-justified);
        @apply(--layout-wrap);
      }
      input-image {
        width: 200px;
        padding: 10px;
        text-align: center;
      }
      .metablocks {
        margin: 10px;
        width: 300px;
      }
    </style>
    <input-image gps="{{gps}}" cam-make="{{make}}" cam-model="{{model}}" exif="{{exif}}" log label="image" class="metablocks" value="{{bigImage}}" width="500" set-width="500" max-width="500" max-height="500"></input-image>
    <template is="dom-if" if="[[_big]]">
      <image-base64 url="[[bigImage]]" width="250" max-height="250" max-width="250" base64="{{image}}"></image-base64>
    </template>
    <div class="metablocks">
      <paper-input label="Title" value="{{title}}"></paper-input>
      <paper-textarea label="tags" value="{{tags}}"></paper-textarea>
      <paper-textarea label="Description" char-counter maxlength="60" value="{{desc}}"></paper-textarea>
    </div>
    <div class="metablocks"> add a location
      <switchable-block opened="{{location}}">
        <location-picker map-zoom="{{mapZoom}}" latitude="{{latitude}}" longitude="{{longitude}}"></location-picker>
        <browser-location latitude="{{latitude}}" longitude="{{longitude}}"></browser-location>
        <template is="dom-if" if={{gps}}>
          <paper-button on-tap="gpsFromImage">at Image</paper-button>
        </template>
      </switchable-block>
    </div>
  </template>
</dom-module>

<script>
  Polymer({
    is: "card-meta-edit",
    properties:{
      title:{
        // Title of the Card
        type:String,
        notify:true,
      },
      bigImage:{
        // Image of the Big Card
        type:String,
        notify:true,
        observer: '_outputImage',
      },
      image:{
        // Image of the Card
        type:String,
        notify:true,
      },
      desc:{
        // Desciption of the Card
        type:String,
        notify:true,
      },
      exif:{
        notify:true,
      },
      latitude:{
        notify:true,
      },
      longitude:{
        notify:true,
      },
      geoHash:{
        notify:true,
        computed: "encodeGeoHash(latitude, longitude, mapZoom) "
      },
      mapZoom:{
        notify:true,
      },
      tags:{
        notify:true,
      },
      gps:{
        notify:true,
      }
    },
    encodeGeoHash(latitude, longitude, mapZoom) {
      var saveSize = 9
      if (mapZoom < 16) {
        saveSize = 8
      }
      if (mapZoom < 15) {
        saveSize = 7
      }
      if (mapZoom < 13) {
        saveSize = 6
      }
      if (mapZoom < 11) {
        saveSize = 5
      }
      if (mapZoom < 7) {
        saveSize = 4
      }
      if (mapZoom < 4) {
        saveSize = 3
      }
      if (mapZoom < 3) {
        saveSize = 2
      }
      return encodeGeoHash(latitude, longitude).substring(0,saveSize)
    },
    gpsFromImage: function(){
      if (this.gps.split(",")[1]) {
        this.latitude = this.gps.split(",")[0]
        this.longitude = this.gps.split(",")[1]
      }
    },
    _outputImage: function(bigImage) {
      var that = this
      this.debounce("set_big",
        function() {
          that._big = that.bigImage
        }
      , 750)
    },
  })
</script>
